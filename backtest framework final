{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "abb2addc",
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "\n",
    "pd.set_option(\"display.max_rows\", 200)\n",
    "pd.set_option(\"display.max_columns\", 50)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "69a167d9",
   "metadata": {},
   "outputs": [],
   "source": [
    "def build_backtest_df(price_df: pd.DataFrame, signal: pd.Series) -> pd.DataFrame:\n",
    "    df = price_df.copy().sort_index()\n",
    "\n",
    "    # daily returns\n",
    "    df[\"ret\"] = df[\"Close\"].pct_change().fillna(0.0)\n",
    "\n",
    "    # align signal to df index\n",
    "    sig = signal.reindex(df.index).fillna(0).astype(int)\n",
    "    df[\"signal\"] = sig\n",
    "\n",
    "    # IMPORTANT: trade at next day close => shift signal by 1 day for position\n",
    "    df[\"position\"] = df[\"signal\"].shift(1).fillna(0).astype(int)\n",
    "\n",
    "    # strategy returns\n",
    "    df[\"strategy_ret\"] = df[\"position\"] * df[\"ret\"]\n",
    "\n",
    "    # equity curves start at 1.0\n",
    "    df[\"equity_buy_hold\"] = (1.0 + df[\"ret\"]).cumprod()\n",
    "    df[\"equity_strategy\"] = (1.0 + df[\"strategy_ret\"]).cumprod()\n",
    "\n",
    "    return df\n",
    "\n",
    "\n",
    "def compute_trade_count(position: pd.Series) -> int:\n",
    "    pos = position.fillna(0).astype(int)\n",
    "    # entries are 0 -> 1\n",
    "    entries = (pos.diff() == 1).sum()\n",
    "    return int(entries)\n",
    "\n",
    "\n",
    "def compute_metrics(bt: pd.DataFrame) -> dict:\n",
    "    total_return = bt[\"equity_strategy\"].iloc[-1] - 1.0\n",
    "    buy_hold_return = bt[\"equity_buy_hold\"].iloc[-1] - 1.0\n",
    "    n_trades = compute_trade_count(bt[\"position\"])\n",
    "\n",
    "    # optional “nice to have” metrics\n",
    "    daily = bt[\"strategy_ret\"]\n",
    "    vol = float(daily.std() * np.sqrt(252)) if daily.std() != 0 else np.nan\n",
    "    sharpe = float((daily.mean() / daily.std()) * np.sqrt(252)) if daily.std() != 0 else np.nan\n",
    "    max_dd = float(((bt[\"equity_strategy\"] / bt[\"equity_strategy\"].cummax()) - 1.0).min())\n",
    "\n",
    "    return {\n",
    "        \"total_return_strategy\": float(total_return),\n",
    "        \"total_return_buy_hold\": float(buy_hold_return),\n",
    "        \"number_of_trades\": int(n_trades),\n",
    "        \"annualized_vol\": vol,\n",
    "        \"sharpe_approx\": sharpe,\n",
    "        \"max_drawdown\": max_dd,\n",
    "    }\n",
    "\n",
    "\n",
    "def plot_equity_curve(bt: pd.DataFrame, title=\"Equity Curve\"):\n",
    "    plt.figure(figsize=(12, 4))\n",
    "    plt.plot(bt.index, bt[\"equity_strategy\"], label=\"Strategy\")\n",
    "    plt.plot(bt.index, bt[\"equity_buy_hold\"], label=\"Buy & Hold\", alpha=0.7)\n",
    "    plt.title(title)\n",
    "    plt.xlabel(\"Date\")\n",
    "    plt.ylabel(\"Equity (start=1.0)\")\n",
    "    plt.legend()\n",
    "    plt.grid(True, alpha=0.3)\n",
    "    plt.show()\n",
    "\n",
    "\n",
    "def plot_price_with_signals(bt: pd.DataFrame, title=\"Price with Buy/Sell Markers\"):\n",
    "    pos = bt[\"position\"].fillna(0).astype(int)\n",
    "    entry = (pos.diff() == 1)\n",
    "    exit_ = (pos.diff() == -1)\n",
    "\n",
    "    plt.figure(figsize=(12, 4))\n",
    "    plt.plot(bt.index, bt[\"Close\"], label=\"Close\")\n",
    "    plt.scatter(bt.index[entry], bt.loc[entry, \"Close\"], marker=\"^\", label=\"Buy (enter long)\")\n",
    "    plt.scatter(bt.index[exit_], bt.loc[exit_, \"Close\"], marker=\"v\", label=\"Sell (exit to cash)\")\n",
    "    plt.title(title)\n",
    "    plt.xlabel(\"Date\")\n",
    "    plt.ylabel(\"Price\")\n",
    "    plt.legend()\n",
    "    plt.grid(True, alpha=0.3)\n",
    "    plt.show()\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.1"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
